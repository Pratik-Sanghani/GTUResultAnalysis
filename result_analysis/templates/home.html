{% load staticfiles %}

<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Bootstrap css -->
	<link rel="stylesheet" href='{% static "bs/css/bootstrap.min.css" %}'>
<!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
 -->
	<!-- Bootstrap js -->
	<script src="{% static 'bs/js/bootstrap.min.js' %}"></script>

	<!-- Jquery -->
	<script src="{% static 'jquery/jquery-3.3.1.min.js' %}"></script>

	<!-- Custom stylesheet -->
    <link rel="stylesheet" href='{% static "css/home.css" %}'>

    <!-- Custom js -->
	<script type="text/javascript">
		$(function() {
			// Do not change these variable
		    var dropdownData = {{ dropdown_data | safe }};
		    var filterData = {{ filters | safe }}
		    var instituteData = {{ institutes | safe }}

			function reset_dropdown(dropdown) {
				var first_op = dropdown.children()[0];
				dropdown.html(first_op);
				return;
			}

			function reset_filter_tables(div_element) {
				div_element.html("");
			}

		    function get_branches_of_session(session) {
				return dropdownData[session];
		    }

			function fill_dropdown_options(dropdown, options) {
				reset_dropdown(dropdown);
				for(var i = 0; i < options.length; i++) {
					var opt = document.createElement('option');
					opt.innerHTML = options[i];
					opt.value = options[i];
					dropdown[0].appendChild(opt);
				}
				return;
			}

			function fill_table_rows(table, rows, columns) {
				// First insert headers
				var headers = table.insertRow(0);
				for(var i = 0; i < columns.length; i++) {
					var header = headers.insertCell(i);
					header.innerHTML = columns[i];
				}

				for(var j = 1; j < Object.keys(rows).length; j++) {
					var t_row = table.insertRow(j);
					for(var i = 0; i < columns.length; i++) {
						var t_column = t_row.insertCell(i);
						t_column.innerHTML = rows[j - 1][columns[i]];
					}
				}
			}

			function fill_table(table, data) {
				fill_table_rows(table, data["row"], data["column"]);
			}

			function fill_all_tables_data(div_element, table_data) {
				console.log(table_data)
				var no_of_tables = Object.keys(table_data);
				console.log(no_of_tables)
				reset_filter_tables(div_element)
				for(var i in no_of_tables) {
					// Append table header
					var table_header = document.createElement("h4");
					table_header.innerHTML = no_of_tables[i];
					div_element[0].appendChild(table_header);

					// Append table
					var table_name = no_of_tables[i];
					var table_ele = document.createElement("table");
					table_ele.setAttribute("id", table_name);
					table_ele.setAttribute("class", "table table-bordered")
					console.log(table_name, table_data[table_name]);
					fill_table(table_ele, table_data[table_name]);
					div_element[0].appendChild(table_ele);
				}
			}

			function do_ajax_request() {
				$.ajax({
					url: '/filter/',
					data: {
						'year': $("#session")[0].value,
						'branch': $("#branch")[0].value,
						'criteria': $("#criteria")[0].value,
						'institute': $("#institute")[0].value,
					},
					dataType: 'json',
					success: function (data) {
						console.log(data);
						if (data["error-msg"] !== undefined) {
							$("#error-msg").text(data["error-msg"])
						} else {
							fill_all_tables_data($("#filter_data"), data["result"]);
						}
					}
				});
			}

			// Fill the dropdown
			fill_dropdown_options($("#session"), Object.keys(dropdownData));
			fill_dropdown_options($("#criteria"), Object.keys(filterData));
			fill_dropdown_options($("#institute"), Object.keys(instituteData));

			// Event listener
			$("#session").on("change", function () {
				if (this.value === "") {
					reset_dropdown($("#branch"));
				}
				else {
					var selected_session = this.value;
					var branches = get_branches_of_session(selected_session);
					fill_dropdown_options($("#branch"), branches);
				}
			});

			$("#criteria").on("change", function () {
				if (this.value === "") {
					return;
				}
				if (this.value.toLowerCase().indexOf("institute") > -1) {
					$("#institute").parent().show();
				} else {
					// FIX: Set default value in dropdown.
					$("#institute").parent().hide();
					do_ajax_request();
				}
			});

			$("#institute").on("change", function () {
				if (this.value === "") {
					return;
				} else {
					do_ajax_request();
				}
			});

		});



	</script>

    <title>GTU | Result Analysis</title>
</head>

<body style='background: url({% static "image/background.jpg" %})'>
	<div class="container">
    <!-- Navigation -->
    <nav class="navbar navbar-light bg-light">
	  <a class="navbar-brand" href="#">
	    <img src="{% static 'image/logo.png' %}" class="img-fluid img-thumbnail image" alt="Responsive image" />
	    <h4 style="margin-left: 90px;">Gujarat Technological University <br />Ahmedabad</h4>
	  </a>
	</nav>
	
	<marquee direction="left" style="background-color:white; color: red;">Cancel Status of student at the time of exam form generation and hall-ticket generation, if system found any issues, then system will automatically be cancelled.</marquee>
	<br>


	<nav class="navbar navbar-expand-sm navbar-dark" id="mainNav">
			<div class="collapse navbar-collapse" id="navbarResponsive">
				<ul class="navbar-nav mx-auto">
					<li class="nav-item active ">
						<a class="nav-link text-uppercase text-expanded" href="index.html">Home
							<span class="sr-only">(current)</span>
						</a>
					</li>
					<li class="nav-item ">
						<a class="nav-link text-uppercase text-expanded" href="#">Re-check</a>
					</li>
					<li class="nav-item ">
						<a class="nav-link text-uppercase text-expanded" href="#">Elective</a>
					</li>
					<li class="nav-item ">
						<a class="nav-link text-uppercase text-expanded" href="#">Exam Form</a>
					</li>
					<li class="nav-item ">
						<a class="nav-link text-uppercase text-expanded" href="#">Exam Data Reports</a>
					</li>
					<li class="nav-item ">
						<a class="nav-link text-uppercase text-expanded" href="#">Others</a>
					</li>
					<li class="nav-item ">
						<a class="nav-link text-uppercase text-expanded" href="#">Staff</a>
					</li>
				</ul>
			</div>
	</nav>	

		<div class="card card-block bg-faded">
		<div style="background-color:white">
			<h5 style="background-color:#2db300">
				Result Session ::
				<select id="session">
					<option value="">Select session</option>
				</select>
			</h5>
			<div id="error-msg" class="alert-danger"></div>
			<br>
				Branch :
				<select id="branch">
					<option value="">Select branch</option>
				</select>
			<br>
	 		<br>
				Criteria:
				<select id="criteria">
					<option value="">Select criteria</option>
				</select>
			<br>
			<br>
			<div style="display: none;">
				Institute:
				<select id="institute">
					<option value="">Select institute</option>
				</select>
			<br>
			<br>				
			</div>
			<center>
				<div id="filter_data"></div>
				<br>
			<a href="#">Download PDF|</a>
			<a href="#">Cancel Download</a>
			</center>
		</div>
	</div>
</div>
</body>
</html>
